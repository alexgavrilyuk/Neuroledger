# backend/src/features/code_execution/README.md
# ** UPDATED FILE - Reflect new data input method **

## Feature: Code Execution Service

This feature slice is responsible for **securely executing** the React code generated by the AI model (Claude) in Phase 5 and beyond.

---
**ðŸš¨ CRITICAL SECURITY WARNING ðŸš¨**

The current implementation (`new Function()`) is **NOT SECURE** for untrusted code and is a **functional placeholder ONLY**. A production system **MUST** use a robust sandboxing technology (Docker, Firecracker, gVisor, etc.).
---

### Core Flow (Conceptual - Placeholder Implementation - Revised for Phase 5 Fix)

1.  **Input:** Receives a string containing React component code (`codeString`) and `executionContext`. The context now includes the **actual pre-fetched content** of the selected datasets: `{ datasets: [{ name: string, gcsPath: string, content: string | null, error?: string }] }`.
2.  **Environment Setup:** Prepares a limited execution scope (`executionScope`) providing access *only* to necessary libraries (React, ReactDOMServer, Recharts, PapaParse, Lodash) and the `datasets` prop containing the actual data content. The `fetchData` function is **removed** from the scope. Access to sensitive globals is prevented.
3.  **Execution:**
    *   Wraps the input `codeString` (assumed to define `ReportComponent`) within code that uses `ReactDOMServer.renderToString` to render the component. **Crucially, the `datasets` array (with content) is passed as a prop to `ReportComponent`.**
    *   **[Placeholder]:** Uses `new Function()` to execute the combined code within the prepared scope. The generated code is expected to parse and analyze the data received via props synchronously for SSR.
    *   Captures the resulting HTML string or any runtime errors.
4.  **Output:** Returns a structured result object (`{ status: 'success', output: '<html_string>' }` or `{ status: 'error', message: '...' }`). Includes a check for minimal output length.

### Files

*   **`execution.service.js`**: Contains `executeGeneratedCode` and the **(INSECURE PLACEHOLDER)** execution logic. Also exports `fetchDataForSandbox` for use by the prompt service *before* calling execution.
*   **`README.md`**: This file.

### Dependencies

*   `react`, `react-dom/server`, `papaparse`, `lodash`, `recharts` (Made available to the sandbox)
*   `logger`

### Interaction

*   Called by `features/prompts/prompt.service.js` after code generation *and* after pre-fetching data content.
*   Does **not** expose direct HTTP routes.

### Security Considerations

*   **Sandboxing:** Critical. Current method unsafe.
*   **Resource Limits:** Essential for production.
*   **Network Access:** Should be disabled in sandbox.
*   **Data Access:** Controlled by passing data explicitly.
*   **Error Handling:** Handle internal code errors, timeouts.
*   **Dependency Management:** Control libraries available to sandbox.