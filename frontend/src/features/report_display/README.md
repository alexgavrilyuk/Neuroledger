// ================================================================================
// FILE: NeuroLedger/frontend/src/features/report_display/README.md
// ================================================================================
# frontend/src/features/report_display/README.md
# ** UPDATED FILE - Reflect Iframe execution **

## Feature: Report Display (Iframe Approach)

This feature slice is responsible for rendering the dynamic report generated by the AI by executing the received React code within a **sandboxed `<iframe>`**.

### Core Flow

1.  **Trigger:** A component (e.g., `DashboardPage`) initiates the report view, providing `reportInfo` (containing `code` string and `datasets` array) and the current `themeName` to the `ReportViewer`.
2.  **Iframe Creation (`ReportViewer.jsx`):**
    *   Renders an `<iframe>` element.
    *   Sets the `src` attribute to `/iframe-bootstrapper.html`. This static HTML file contains logic to load necessary libraries (React, Recharts, etc.) via CDN and includes a script to listen for messages.
    *   Sets a strict `sandbox="allow-scripts"` attribute. This allows JavaScript execution *inside* the iframe but **prevents** it from accessing the parent window's origin (cookies, localStorage, DOM manipulation outside the iframe), making network requests as the parent, submitting forms, opening popups, etc.
3.  **Loading & Initialization:**
    *   The `ReportViewer` listens for the iframe's `onLoad` event.
    *   Once loaded, it uses `iframe.contentWindow.postMessage` to send two messages **into** the iframe (specifying the correct `targetOrigin` for security):
        *   `{ type: 'setTheme', payload: { name: themeName } }`: To apply initial styling.
        *   `{ type: 'loadDataAndCode', payload: { code: reportInfo.code, datasets: reportInfo.datasets } }`: Sending the AI code and processed data.
4.  **Iframe Execution (`iframe-bootstrapper.html`):**
    *   The bootstrapper script waits for library scripts (React, Recharts, etc.) to load and for the `loadDataAndCode` message.
    *   It then executes the received `code` string (using `new Function()`) within the iframe's context, passing the libraries and `datasets`.
    *   It uses `ReactDOM.createRoot().render()` *inside the iframe* to render the AI-generated `ReportComponent` into a `<div id="report-root">`.
    *   It sends status messages (`'success'` or `'error'` with details) back to the parent `ReportViewer` using `postMessage`.
5.  **Status Update & Display:**
    *   `ReportViewer` listens for `postMessage` events *from* the iframe (checking the origin).
    *   It updates its internal state (`iframeStatus`, `iframeError`) based on messages received from the bootstrapper.
    *   It displays loading indicators or error messages based on this status. The rendered report appears directly within the iframe.
6.  **Theme Updates:** `ReportViewer` also listens for changes to the `themeName` prop and sends `setTheme` messages to the iframe whenever the theme changes in the main application.

### Files

*   **`components/`**
    *   `ReportViewer.jsx`: The component that manages and renders the sandboxed `<iframe>` and handles communication.
*   **`README.md`**: This file.
*   **`../../public/iframe-bootstrapper.html`**: (New) The static HTML file loaded into the iframe, responsible for loading libraries and executing the AI code.

### Dependencies

*   Shared UI (`Spinner`)
*   Heroicons (for error icon)

### Security Considerations

*   **`sandbox="allow-scripts"`:** This is the core mechanism. It allows JS execution but heavily restricts the iframe's capabilities, isolating it from the parent page. **NEVER add `allow-same-origin` unless you fully understand the severe security implications.**
*   **`postMessage` Origin Checks:** Both the parent sending messages *to* the iframe and the iframe sending messages *back* MUST specify and check the `targetOrigin` / `event.origin` respectively to prevent cross-site scripting (XSS) attacks.
*   **`new Function()` Risk:** While sandboxed, executing arbitrary code is still inherently risky. The sandbox limits damage, but doesn't eliminate the risk of resource exhaustion or potential (though harder) sandbox escapes. Trust in the AI's generated code quality is still a factor.
*   **CDN Dependencies:** Loading libraries via CDN introduces trust in the CDN provider. Self-hosting provides more control.

### Usage

The `ReportViewer` is used within a container (like a `Modal` in `DashboardPage`) and requires the `reportInfo` object (containing `code` and `datasets`) and the current `themeName` as props.